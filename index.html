<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Character Profile Builder</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .form-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
        }
        .form-field {
            display: flex;
            flex-direction: column;
        }
        label {
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #374151;
            display: flex;
            align-items: center;
        }
        input[type="checkbox"] {
            margin-right: 0.5rem;
            height: 1rem;
            width: 1rem;
            accent-color: #4f46e5;
        }
        input[type="text"], textarea {
            border-radius: 0.5rem;
            border: 1px solid #d1d5db;
            padding: 0.75rem 1rem;
            transition: border-color 0.2s, box-shadow 0.2s, background-color 0.2s;
        }
        input[type="text"]:focus, textarea:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
        }
        .populated {
            background-color: #e5e7eb;
            border-color: #9ca3af;
        }
        .error-message {
            color: #dc2626;
            background-color: #fee2e2;
            border-left: 4px solid #b91c1c;
            padding: 1rem;
            margin-top: 1rem;
            border-radius: 0.375rem;
        }
        .output-box {
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            padding: 1rem;
            border-radius: 0.5rem;
            height: 300px; /* Or a suitable height */
            overflow-y: auto;
        }
        /* Spinner is removed, so no styles are needed */
    </style>
</head>
<body class="text-gray-800">

    <!-- Main Container -->
    <div class="container mx-auto p-4 sm:p-6 lg:p-8">
        <header class="text-center mb-10">
            <h1 class="text-3xl sm:text-4xl lg:text-5xl font-bold text-gray-900">Character Profile Builder</h1>
            <p class="mt-3 text-md sm:text-lg text-gray-600 max-w-2xl mx-auto">Check the boxes for AI generation or fill in the fields with your own data.</p>
        </header>

        <div class="space-y-8 max-w-4xl mx-auto">
            <!-- Input Form Section -->
            <div class="bg-white p-6 rounded-xl shadow-lg">
                <form id="character-form" class="space-y-8">
                    <!-- Fields remain the same -->
                     <div class="form-section">
                        <div class="form-field">
                            <label for="name"><input type="checkbox" id="cb-name" name="cb-name" checked>Name</label>
                            <input type="text" id="name" name="name" placeholder="e.g., Alistair Croft">
                        </div>
                        <div class="form-field">
                            <label for="genre"><input type="checkbox" id="cb-genre" name="cb-genre" checked>Genre</label>
                            <input type="text" id="genre" name="genre" placeholder="e.g., Sci-Fi, Fantasy, Noir">
                        </div>
                    </div>
                    <div class="form-field"><label for="core-description"><input type="checkbox" id="cb-core-description" name="cb-core-description" checked>Core Description</label><textarea id="core-description" name="core-description" rows="3" placeholder="A high-level summary of the character."></textarea></div>
                    <div class="form-field"><label for="appearance"><input type="checkbox" id="cb-appearance" name="cb-appearance" checked>Appearance</label><textarea id="appearance" name="appearance" rows="4" placeholder="Describe their physical looks, clothing, and style."></textarea></div>
                    <div class="form-field"><label for="backstory"><input type="checkbox" id="cb-backstory" name="cb-backstory" checked>Backstory</label><textarea id="backstory" name="backstory" rows="5" placeholder="Detail their history, significant life events, and origins."></textarea></div>
                    <div class="form-field"><label for="personality"><input type="checkbox" id="cb-personality" name="cb-personality" checked>Personality Traits</label><textarea id="personality" name="personality" rows="3" placeholder="e.g., Witty, cautious, fiercely loyal..."></textarea></div>
                    <div class="form-section"><div class="form-field"><label for="skills"><input type="checkbox" id="cb-skills" name="cb-skills" checked>Skills</label><input type="text" id="skills" name="skills" placeholder="e.g., Lockpicking, alchemy"></div><div class="form-field"><label for="abilities"><input type="checkbox" id="cb-abilities" name="cb-abilities" checked>Abilities</label><input type="text" id="abilities" name="abilities" placeholder="e.g., Minor pyromancy"></div></div>
                    <div class="form-section"><div class="form-field"><label for="goals"><input type="checkbox" id="cb-goals" name="cb-goals" checked>Goals</label><textarea id="goals" name="goals" rows="3" placeholder="Short-term and long-term goals."></textarea></div><div class="form-field"><label for="motivations"><input type="checkbox" id="cb-motivations" name="cb-motivations" checked>Motivations</label><textarea id="motivations" name="motivations" rows="3" placeholder="What drives them?"></textarea></div></div>
                    <div class="form-field"><label for="weaknesses"><input type="checkbox" id="cb-weaknesses" name="cb-weaknesses" checked>Weaknesses</label><input type="text" id="weaknesses" name="weaknesses" placeholder="e.g., Fear of heights, overly trusting"></div>
                    <div class="form-field"><label for="equipment"><input type="checkbox" id="cb-equipment" name="cb-equipment" checked>Equipment</label><textarea id="equipment" name="equipment" rows="3" placeholder="What items do they carry?"></textarea></div>
                    <div class="form-field"><label for="relationships"><input type="checkbox" id="cb-relationships" name="cb-relationships" checked>Relationships</label><textarea id="relationships" name="relationships" rows="4" placeholder="Family, friends, rivals, etc."></textarea></div>
                    <div class="form-field"><label for="notes"><input type="checkbox" id="cb-notes" name="cb-notes" checked>Additional Notes</label><textarea id="notes" name="notes" rows="4" placeholder="Any other important details, quirks, or information."></textarea></div>

                    <!-- Action Buttons -->
                    <div class="flex items-center justify-end mt-8">
                        <button type="button" id="generate-btn" class="inline-flex justify-center py-3 px-6 border border-transparent shadow-sm text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500">
                            Generate
                        </button>
                    </div>
                </form>
            </div>

            <!-- Output Sections -->
            <!-- Workup Output -->
            <div class="bg-white p-6 rounded-xl shadow-lg output-container">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-bold">Workup</h2>
                    <div class="flex space-x-2">
                         <button class="copy-btn py-1 px-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" data-target="output-workup">Copy</button>
                         <button class="save-btn py-1 px-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" data-target="output-workup" data-format="txt">Save</button>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mb-4">Full character details. Optimized for character concepting.</p>
                <div class="output-box">
                    <pre id="output-workup" class="whitespace-pre-wrap text-sm text-gray-800"></pre>
                </div>
            </div>

            <!-- Markdown Output -->
            <div class="bg-white p-6 rounded-xl shadow-lg output-container">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-bold">Markdown</h2>
                     <div class="flex space-x-2">
                        <button class="copy-btn py-1 px-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" data-target="output-markdown">Copy</button>
                        <button class="save-btn py-1 px-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" data-target="output-markdown" data-format="md">Save</button>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mb-4">Condensed information from workup. Optimized for short notes.</p>
                 <div class="output-box">
                    <pre id="output-markdown" class="whitespace-pre-wrap text-sm text-gray-800"></pre>
                </div>
            </div>

            <!-- JSON Output -->
            <div class="bg-white p-6 rounded-xl shadow-lg output-container">
                <div class="flex justify-between items-center mb-2">
                    <h2 class="text-xl font-bold">JSON</h2>
                    <div class="flex space-x-2">
                         <button class="copy-btn py-1 px-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" data-target="output-json">Copy</button>
                         <button class="save-btn py-1 px-3 border border-gray-300 shadow-sm text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50" data-target="output-json" data-format="json">Save</button>
                    </div>
                </div>
                <p class="text-sm text-gray-500 mb-4">Basic and simplified outline. Optimized for token economy.</p>
                 <div class="output-box">
                    <pre id="output-json" class="whitespace-pre-wrap text-sm text-gray-800"></pre>
                </div>
            </div>
             <p id="copy-feedback" class="text-sm text-green-600 mt-2 h-4 text-center"></p>
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // API key has been inserted here.
            // IMPORTANT: Be aware of the security risks of exposing this key on a public website.
            const apiKey = "AIzaSyAdECl3fbG0IdbJyJGjq2lbfLoSVdE69EU";

            // --- UI Elements ---
            const form = document.getElementById('character-form');
            const generateBtn = document.getElementById('generate-btn');
            const copyFeedbackEl = document.getElementById('copy-feedback');
            const nameInput = document.getElementById('name');
            
            const outputs = {
                workup: document.getElementById('output-workup'),
                markdown: document.getElementById('output-markdown'),
                json: document.getElementById('output-json')
            };

            const fieldOrder = [
                'name', 'genre', 'core-description', 'appearance', 'backstory', 'personality', 
                'skills', 'abilities', 'goals', 'motivations', 'weaknesses', 
                'equipment', 'relationships', 'notes'
            ];
            
            // --- Shared API Call Function ---
            async function callGemini(prompt, outputElement) {
                outputElement.textContent = 'Generating...';
                
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;
                const payload = { contents: [{ parts: [{ text: prompt }] }] };

                try {
                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) {
                        const errorData = await response.json().catch(() => ({}));
                        const errorMsg = errorData.error?.message || 'An unknown error occurred.';
                        displayError(outputElement, `API Request Failed (Status: ${response.status})`, errorMsg);
                        return null;
                    }

                    const result = await response.json();
                     if (result.candidates?.[0]?.content?.parts?.[0]?.text) {
                        return result.candidates[0].content.parts[0].text;
                    } else {
                        let errorMessage = "No content generated. The model returned an empty response.";
                        if (result.promptFeedback?.blockReason) {
                            errorMessage = `Request blocked. Reason: ${result.promptFeedback.blockReason}. Please adjust your input.`;
                        }
                        displayError(outputElement, "Generation Error", errorMessage);
                        return null;
                    }
                } catch (error) {
                    console.error("Error during API call:", error);
                    displayError(outputElement, "An unexpected error occurred.", `Failed to connect to the API. Error: ${error.message}`);
                    return null;
                }
            }

            // --- UI Interaction Logic ---
            function displayError(element, message, details = '') {
                element.innerHTML = `<div class="error-message" style="height: auto; overflow: visible;"><p class="font-bold">${message}</p><p class="text-sm mt-2">${details}</p></div>`;
            }
            
            fieldOrder.forEach(id => {
                const input = document.getElementById(id);
                const checkbox = document.getElementById(`cb-${id}`);
                input.addEventListener('input', () => {
                    if (input.value.trim() !== '') {
                        input.classList.add('populated');
                        checkbox.checked = false;
                    } else {
                        input.classList.remove('populated');
                    }
                });
            });

            // --- Primary Generation Function ---
            async function generateAllOutputs() {
                generateBtn.disabled = true;
                generateBtn.textContent = 'Generating...';
                
                Object.values(outputs).forEach(o => o.textContent = '');

                // 1. Construct base prompt
                const formData = new FormData(form);
                const fieldMapping = {'name': 'Name', 'genre': 'Genre', 'core-description': 'Core Description', 'personality': 'Personality Traits', 'appearance': 'Appearance', 'backstory': 'Backstory', 'skills': 'Skills', 'abilities': 'Abilities', 'goals': 'Goals', 'motivations': 'Motivations', 'weaknesses': 'Weaknesses', 'equipment': 'Equipment', 'relationships': 'Relationships', 'notes': 'Additional Notes'};

                let isAnyFieldFilled = false, isAnyBoxChecked = false, sectionsToGenerate = [];
                let userDataPrompt = 'Please generate a detailed character profile based on the following user-provided information. Flesh out the character, ensuring all details are coherent and well-integrated.\n\n';
                
                fieldOrder.forEach(key => {
                    const value = formData.get(key), checkbox = document.getElementById(`cb-${key}`);
                    if (value?.trim()) {
                        isAnyFieldFilled = true;
                        userDataPrompt += `## ${fieldMapping[key]}\n${value.trim()}\n\n`;
                    }
                    if (checkbox.checked) {
                        isAnyBoxChecked = true;
                        if (!value?.trim()) sectionsToGenerate.push(fieldMapping[key]);
                    }
                });
                
                let basePrompt = '';
                if (isAnyFieldFilled) {
                    basePrompt = userDataPrompt;
                    if (sectionsToGenerate.length > 0) basePrompt += `\nPlease also generate original content for the following empty sections, ensuring it complements the provided information: ${sectionsToGenerate.join(', ')}.`;
                } else if (isAnyBoxChecked) {
                    basePrompt = `Generate a complete and detailed original character profile from scratch. Include detailed sections for: ${sectionsToGenerate.join(', ')}.`;
                } else {
                    displayError(outputs.workup, "No fields to generate.", "Please check the box next to at least one field or fill in at least one field.");
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate';
                    return;
                }

                // 2. Generate Workup
                const workupPrompt = `${basePrompt}\n\nFormat the entire output as a comprehensive 'Character Workup' document. Use the field names as clear, bold headings (e.g., **Appearance**) and present the information in a well-written, narrative style under each heading. Do not use Markdown '##' headers.`;
                const workupOutput = await callGemini(workupPrompt, outputs.workup);
                if (!workupOutput) {
                    generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate';
                    return;
                }
                outputs.workup.textContent = workupOutput;
                
                // 3. Generate Markdown from Workup
                const markdownPrompt = `Take the following character workup and condense it into a Markdown format. It should be optimized for short notes, using headings and bullet points for clarity. Do not omit key information, but be concise.\n\n---START WORKUP---\n${workupOutput}\n---END WORKUP---`;
                const markdownOutput = await callGemini(markdownPrompt, outputs.markdown);
                if (!markdownOutput) {
                     generateBtn.disabled = false;
                    generateBtn.textContent = 'Generate';
                    return;
                }
                outputs.markdown.textContent = markdownOutput;

                // 4. Generate JSON from Markdown
                const jsonPrompt = `Distill the following Markdown character sheet into a basic and simplified JSON object. The JSON should be optimized for chatbot token economy. Use simple key-value pairs. For lists like skills or equipment, use an array of strings. The entire output must be a single, valid JSON object only.\n\n---START MARKDOWN---\n${markdownOutput}\n---END MARKDOWN---`;
                const jsonOutput = await callGemini(jsonPrompt, outputs.json);
                if (jsonOutput) {
                    outputs.json.textContent = jsonOutput;
                }

                generateBtn.disabled = false;
                generateBtn.textContent = 'Generate';
            }
            
            // --- Utility Functions (Copy, Save) ---
            function copyToClipboard(elementId) {
                const textToCopy = document.getElementById(elementId).textContent;
                if (textToCopy && !document.getElementById(elementId).querySelector('.error-message')) {
                    const tempTextArea = document.createElement('textarea');
                    tempTextArea.value = textToCopy;
                    document.body.appendChild(tempTextArea);
                    tempTextArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(tempTextArea);
                    copyFeedbackEl.textContent = `Copied ${elementId.split('-')[1]}!`;
                    setTimeout(() => { copyFeedbackEl.textContent = ''; }, 2000);
                }
            }

            function saveAsTextFile(elementId, format) {
                const textToSave = document.getElementById(elementId).textContent;
                 if (!textToSave || document.getElementById(elementId).querySelector('.error-message')) {
                    alert("There is no content to save."); // Or use a custom modal
                    return;
                }

                const characterName = nameInput.value.trim().replace(/[^a-z0-9]/gi, '_').toLowerCase() || 'character';
                const filename = `${characterName}_profile.${format}`;
                const blob = new Blob([textToSave], { type: `text/${format};charset=utf-8` });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.setAttribute('href', url);
                link.setAttribute('download', filename);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            }

            // --- Event Listeners ---
            generateBtn.addEventListener('click', generateAllOutputs);
            
            document.querySelectorAll('.copy-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.getAttribute('data-target');
                    copyToClipboard(targetId);
                });
            });

            document.querySelectorAll('.save-btn').forEach(button => {
                button.addEventListener('click', (e) => {
                    const targetId = e.currentTarget.getAttribute('data-target');
                    const format = e.currentTarget.getAttribute('data-format');
                    saveAsTextFile(targetId, format);
                });
            });

        });
    </script>
</body>
</html>
